[z_calibration]
probe_nozzle_x:199.5
probe_nozzle_y:307
probe_switch_x:222.6
probe_switch_y:268.0
probe_bed_x:150
probe_bed_y:150
switch_offset:0.45
clearance:20.0
max_deviation:1.2
probing_first_fast:true
probing_second_speed:0.5
speed:250
start_gcode: DETACH_PROBE
before_switch_gcode: ATTACH_PROBE
end_gcode: DETACH_PROBE

[gcode_macro CALIBRATE_Z]
description: Automatically calibrates the nozzles offset to the print surface and dock/undock MagProbe 
rename_existing: CALIBRATE_Z_BASE
gcode:
   {% set driver_config = printer.configfile.settings['tmc2209 stepper_z'] %}
   {% set RUN_CUR = driver_config.run_current %}
   {% set HOLD_CUR = driver_config.hold_current %}

   SET_TMC_CURRENT STEPPER=stepper_z CURRENT={RUN_CUR} HOLDCURRENT={RUN_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={RUN_CUR} HOLDCURRENT={RUN_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={RUN_CUR} HOLDCURRENT={RUN_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={RUN_CUR} HOLDCURRENT={RUN_CUR}

  CALIBRATE_Z_BASE

   SET_TMC_CURRENT STEPPER=stepper_z CURRENT={RUN_CUR} HOLDCURRENT={HOLD_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={RUN_CUR} HOLDCURRENT={HOLD_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={RUN_CUR} HOLDCURRENT={HOLD_CUR}
   SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={RUN_CUR} HOLDCURRENT={HOLD_CUR}

